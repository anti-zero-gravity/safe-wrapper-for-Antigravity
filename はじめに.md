# はじめに

このフォルダは、Antigravity の自動Accept機能使用時に危険なコマンドを確認ダイアログで保護（ラップ）するための設定ファイル群です。

# できること

コマンド保護の **設定・解除・確認** だけのシンプル設計です。

| コマンド | 動作 |
|---------|------|
| `/設定` | SafeCmd をインストール |
| `/解除` | SafeCmd をアンインストール |
| `/確認` | 現在の状態を確認 |

設定後は、他のワークスペースでもターミナル（管理者）でも確認ダイアログが有効になります。
このワークスペースを使い続ける必要はありません。

6種類の命令それぞれに対して「自動で許可」か「確認する」かを設定できます。
- 命令項目を移動 → [accept_settings.md]を保存 → `/設定`

### PowerShellプロファイルについて

`/設定` を実行すると、**PowerShell プロファイル（`$PROFILE`）が上書き**されます。
`/設定` を実行した後、`Ctrl+Shift+P` から `reload` で検索し、「**開発者: ウィンドウの再読み込み**」をクリックしてください。

#### 自動バックアップ機能
- **既存プロファイルがある場合**: `Microsoft.PowerShell_profile.ps1$` に自動バックアップ
- **既存プロファイルがない場合**: プレースホルダーファイルを作成
- **既にバックアップがある場合**: 上書きしません（安全機能）

#### プロファイルマージ機能
既存のプロファイル（Anacondaの `conda init` コードなど）がある場合、SafeCmdプロファイルの先頭に自動的にコピーされます。

#### アンインストール時 (`/解除`)
- SafeCmdプロファイルを削除
- **バックアップが本物のプロファイル**: 自動的に復元
- **バックアップがプレースホルダー**: 削除のみ

> [!NOTE]
> `/解除` は PowerShell プロファイルを元に戻す操作のみを行います。
> このツールが入っているフォルダ（`safe-wrapper`）自体は削除されません。不要になった場合はフォルダごと削除してください。

---

### ラップ適用範囲外

以下の AI ツールは PowerShell を経由しないため、**確認ダイアログは表示されません**:

#### AI ファイル操作ツール（ワークスペース内のみ）
- `write_to_file`
- `replace_file_content`
- `multi_replace_file_content`

#### AI が直接できない操作（run_command 経由が必要）
以下の操作は `run_command` (PowerShell) を経由するため、基本的に SafeCmd が機能します。
ただし cmd.exe など PowerShell 以外を経由した場合は保護されません。

---

### AI のデフォルト動作

- AI は**デフォルトで PowerShell を使用**します
- よって、通常の操作では自動的にラップが適用されます
- `net`, `sc` などの外部コマンドは PowerShell プロファイルの影響を受けないため制限できません

### Terminal Blindness Prevention

AI実行環境では、出力解析を妨害する装飾を自動無効化します。

**検出条件**:
- `$env:TERM_PROGRAM -eq 'vscode'`
- `$env:ANTIGRAVITY_AGENT` 環境変数
- 非対話モード

**無効化される項目**:
- プログレスバー表示
- PSReadLine装飾（シンタックスハイライト、予測入力）
- プロンプトカスタマイズ（Oh My Posh、Starship等）
- ANSIエスケープシーケンス（カラー出力、カーソル制御）

---

## プロファイル適用範囲（`safe-cmd-msgbox.ps1` が代行）

### ✅ 適用されない
- 他のプログラムからの PowerShell 呼び出し
- OS スケジュールタスク
- バッチファイルからの呼び出し
- `-NoProfile` オプション付き実行

### ❌ 適用される
- 対話型 PowerShell（ユーザーが起動）
- AI の `run_command`（デフォルト設定）